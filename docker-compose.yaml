networks:
  default: {}
  backend:
    ipam:
      config:
        - subnet: 172.52.0.0/16
  WEBPASSWORD:
    file: '${PWD}/.secrets/WEBPASSWORD'
services:
  cloudflared:
    command: "tunnel --no-autoupdate run --token ${CLOUDFLARED_TOKEN}"
    container_name: cloudflared
    env_file: .env
    image: cloudflare/cloudflared:latest
    profiles: ['external']
    restart: unless-stopped
  dhcphelper:
    cap_add:
      - NET_ADMIN
    container_name: dhcphelper
    environment:
      - IP=172.52.0.10
    image: homeall/dhcphelper:latest
    network_mode: host
    profiles: ['local']
    restart: unless-stopped
  ddns:
    container_name: ddns
    env_file: .env
    environment:
      API_KEY: "${CF_TOKEN}" # confusing name, must be an API token
      ZONE: "${CF_ZONE}"
      SUBDOMAIN: "*"
      PROXIED: "true"
    image: oznu/cloudflare-ddns:latest
    profiles: ['external']
    restart: unless-stopped
  flaresolverr:
    container_name: flaresolverr
    env_file: .env
    environment:
      - LOG_LEVEL=info
    image: ghcr.io/flaresolverr/flaresolverr:latest
    ports:
      - 8191:8191
    profiles: ['local']
    restart: unless-stopped
  nginx-proxy-manager:
    container_name: nginx-proxy-manager
    image: jc21/nginx-proxy-manager:latest
    ports:
      - 8080:80
      - 8081:81
      - 8443:443
    profiles: ['external']
    restart: unless-stopped
    volumes:
      - ./app/nginx-proxy-manager/data:/data
      - ./app/letsencrypt:/etc/letsencrypt
  ntfy:
    command:
      - serve
    container_name: ntfy
    env_file: .env
    image: binwiederhier/ntfy:latest
    labels:
      - traefik.enable=true
      - traefik.http.routers.ntfy.rule=Host(`ntfy.stargate.${DOMAIN}`)
      - traefik.http.routers.ntfy.tls=true
      - traefik.http.routers.ntfy.entrypoints=websecure
      - traefik.http.services.ntfy.loadbalancer.server.port=80
    restart: unless-stopped
  pihole:
    cap_add:
      - NET_ADMIN
    container_name: pihole
    depends_on:
      - traefik
    env_file: .env
    environment:
      WEBPASSWORD_FILE: "/run/secrets/WEBPASSWORD"
    image: pihole/pihole:latest
    labels:
      - traefik.docker.network=backend
      - traefik.enable=true
      - traefik.http.routers.pihole.entrypoints=websecure
      - traefik.http.routers.pihole.rule=Host(`pihole.${DOMAIN}`)
      - traefik.http.routers.pihole.tls=true
      - traefik.http.services.pihole.loadbalancer.server.port=80
    networks:
      default: {}
      backend:
        ipv4_address: "172.52.0.10"
    ports:
      - 53:53/tcp
      - 53:53/udp
      - 81:80
    restart: unless-stopped
    secrets:
      - WEBPASSWORD
    volumes:
      - ${PWD}/dnsmasq.d:/etc/dnsmasq.d
      - ${PWD}/pihole:/etc/pihole
  portainer:
    command: -H unix:///var/run/docker.sock --admin-password "${ADMIN_PASSWORD_HASH}"
    container_name: portainer
    env_file: .env
    image: portainer/portainer-ce
    labels:
      - traefik.enable=true
      - traefik.http.routers.portainer.entrypoints=websecure
      - traefik.http.routers.portainer.rule=Host(`portainer.${DOMAIN}`)
      - traefik.http.routers.portainer.tls=true
      - traefik.http.services.portainer.loadbalancer.server.port=9000
    ports:
      - 9000:9000
    volumes:
      - ${PWD}/portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
  traefik:
    command:
      - --api.dashboard=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme.json
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls.certResolver=letsencrypt
      - --entrypoints.websecure.http.tls.domains[0].main=${DOMAIN}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN}
      - --entrypoints.websecure.http.tls=true
      - --log.level=DEBUG
      - --providers.docker.exposedbydefault=true
      - --providers.docker=true
      - --serverstransport.insecureskipverify=true
    container_name: traefik
    env_file: .env
    environment:
      CLOUDFLARE_DNS_API_TOKEN: "${CF_TOKEN}"
      CLOUDFLARE_EMAIL: "${CF_EMAIL}"
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL: "${CF_EMAIL}"
    image: traefik:latest
    labels:
      - traefik.enable=true
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.routers.dashboard.tls=true
    ports:
      - 80:80
      - 443:443
    restart: unless-stopped
    volumes:
      - ${PWD}/traefik/acme.json:/etc/traefik/acme.json
      - /var/run/docker.sock:/var/run/docker.sock
  unifi-db:
    env_file: .env
    image: docker.io/mongo:7.0.8
    container_name: unifi-db
    volumes:
      - ./app/unifi-db/db:/data/db
      - ./app/unifi-db/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    restart: unless-stopped
  unifi-network-application:
    depends_on:
      - unifi-db
    image: lscr.io/linuxserver/unifi-network-application:latest
    container_name: unifi-network-application
    env_file: .env
    volumes:
      - ./app/unifi-network-application:/config
    ports:
      - 18443:8443
      - 3478:3478/udp
      - 10001:10001/udp
      - 18080:8080
      - 1900:1900/udp #optional
      - 18843:8843 #optional
      - 18880:8880 #optional
      - 6789:6789 #optional
      - 5514:5514/udp #optional
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.unifi.rule=Host(`unifi.stargate.${DOMAIN}`)
      - traefik.http.routers.unifi.tls=true
      - traefik.http.routers.unifi.entrypoints=websecure
      - traefik.http.services.unifi.loadbalancer.server.port=8443
      - traefik.http.services.unifi.loadbalancer.server.scheme=https
  watchtower:
    container_name: watchtower
    env_file: .env
    environment:
      WATCHTOWER_SCHEDULE: "0 0 1 * * *"
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_DEBUG: "true"
    image: containrrr/watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  wireguard:
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    container_name: wireguard
    env_file: .env
    environment:
      PASSWORD: "${WEBPASSWORD}"
      WG_HOST: "wireguard.stargate.${DOMAIN}"
    image: weejewel/wg-easy
    labels:
      - traefik.enable=true
      - traefik.http.routers.wireguard.rule=Host(`wireguard.stargate.${DOMAIN}`)
      - traefik.http.routers.wireguard.tls=true
      - traefik.http.routers.wireguard.entrypoints=websecure
      - traefik.http.services.wireguard.loadbalancer.server.port=51821
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    profiles: ['external']
    restart: unless-stopped
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - ./app/wireguard:/etc/wireguard
