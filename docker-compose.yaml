services:
  adguard:
    container_name: adguard
    dns:
      - 76.76.2.2
      - 76.76.10.2
    hostname: adguard
    image: adguard/adguardhome
    labels:
      homepage.description: Ad-Blocking DNS Server
      homepage.group: Core
      homepage.href: https://adguard.${DOMAIN:?no domain provided}
      homepage.icon: adguard-home
      homepage.name: AdGuard Home 1
      homepage.widget.password: ${ADMIN_PASSWORD:?no admin password provided}
      homepage.widget.type: adguard
      homepage.widget.url: https://adguard.${DOMAIN}
      homepage.widget.username: ${ADMIN_USERNAME:?no admin username provided}
      traefik.enable: true
      traefik.http.routers.adguard-main.rule: Host(`adguard.${DOMAIN}`)
      traefik.http.routers.adguard-main.service: adguard
      traefik.http.routers.adguard.rule: Host(`adguard.stargate.${DOMAIN}`)
      traefik.http.services.adguard.loadbalancer.server.port: 80
    ports:
      - 53:53/tcp
      - 53:53/udp
      - 853:853/tcp
      - 853:853/udp
      - 3000:3000/tcp
      - 5443:5443/tcp
      - 5443:5443/udp
      - 6060:6060/tcp
      - 8843:443/tcp
      - 8880:80/tcp
    restart: unless-stopped
    volumes:
      - ./docker/adguard/conf:/opt/adguardhome/conf
      - ./docker/adguard/work:/opt/adguardhome/work
  adguard-sync:
    command: run --config /config/adguardhome-sync.yaml
    container_name: adguard-sync
    image: ghcr.io/bakito/adguardhome-sync
    restart: unless-stopped
    volumes:
      - ./docker/adguard/sync/adguardhome-sync.yaml:/config/adguardhome-sync.yaml

  # ===========================================================================
  # Authelia - Authentication & Authorization (1FA, 2FA, OIDC)
  # ===========================================================================
  authelia:
    cap_drop:
      - ALL
    container_name: authelia
    depends_on:
      traefik:
        condition: service_healthy
    environment:
      AUTHELIA_JWT_SECRET: ${AUTHELIA_JWT_SECRET:?Authelia JWT secret required}
      AUTHELIA_OIDC_CLIENT_WEBAPP_SECRET: ${AUTHELIA_OIDC_CLIENT_WEBAPP_SECRET:?Authelia OIDC webapp client secret required}
      AUTHELIA_OIDC_HMAC_SECRET: ${AUTHELIA_OIDC_HMAC_SECRET:?Authelia OIDC HMAC secret required}
      AUTHELIA_OIDC_ISSUER_PRIVATE_KEY: ${AUTHELIA_OIDC_ISSUER_PRIVATE_KEY:?Authelia OIDC issuer private key required}
      AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_SECRET:?Authelia session secret required}
      AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_STORAGE_ENCRYPTION_KEY:?Authelia storage encryption key required}
      DOMAIN: ${DOMAIN:?Domain required}
      TZ: ${TZ:-UTC}
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: [ "CMD", "wget", "-q", "-O-", "http://localhost:9091/api/health" ]
      timeout: 10s
    hostname: authelia
    image: authelia/authelia:4.38
    labels:
      traefik.enable: true
      # Authelia ForwardAuth middleware with basic auth enabled (for apps that need it)
      traefik.http.middlewares.authelia-basic.forwardAuth.address: http://authelia:9091/api/authz/forward-auth?authelia_url=https://auth.${DOMAIN}
      traefik.http.middlewares.authelia-basic.forwardAuth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Email,Remote-Name
      traefik.http.middlewares.authelia-basic.forwardAuth.trustForwardHeader: true
      # Authelia ForwardAuth middleware for protecting other services
      traefik.http.middlewares.authelia.forwardAuth.address: http://authelia:9091/api/authz/forward-auth
      traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Email,Remote-Name
      traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader: true
      # Main Authelia portal - publicly accessible (auth provider itself)
      traefik.http.routers.authelia.rule: Host(`auth.${DOMAIN}`)
      traefik.http.services.authelia.loadbalancer.server.port: 9091
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    user: 1000:1000
    volumes:
      - ./docker/authelia:/config

  beszel-agent:
    container_name: beszel-agent
    environment:
      KEY: ${BESZEL_KEY:?no beszel key provided}
      LISTEN: 45876
    image: henrygd/beszel-agent
    network_mode: host
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  cadvisor:
    container_name: cadvisor
    devices:
      - /dev/kmsg
    image: gcr.io/cadvisor/cadvisor
    ports:
      - 8081:8080
    privileged: true
    restart: unless-stopped
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
  cloudflared:
    cap_drop:
      - ALL
    command: tunnel --no-autoupdate run
    container_name: cloudflared
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARED_TOKEN:?no cloudflared token provided}
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 60s
      test: [ "CMD", "cloudflared", "version" ]
      timeout: 10s
    image: cloudflare/cloudflared
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "65532:65532"
  ddns:
    cap_drop:
      - all
    container_name: ddns
    environment:
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:?no cloudflare api token provided}
      DOMAINS: "*.${DOMAIN_EXT:?no external domain provided}"
      IP6_PROVIDER: none
      PROXIED: "true"
    image: favonia/cloudflare-ddns
    network_mode: host
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: 1000:1000
  docker-socket-proxy:
    container_name: docker-socket-proxy
    environment:
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
      POST: 0
      SERVICES: 1
      TASKS: 1
      VERSION: 1
      VOLUMES: 1
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 10s
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:2375/_ping || exit 1" ]
      timeout: 10s
    image: ghcr.io/tecnativa/docker-socket-proxy
    labels:
      traefik.enable: false
    ports:
      - 0.0.0.0:2375:2375
    privileged: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  dockhand:
    cap_drop:
      - ALL
    container_name: dockhand
    depends_on:
      traefik:
        condition: service_started
    image: fnsys/dockhand
    labels:
      homepage.description: Docker management interface
      homepage.group: Core
      homepage.icon: mdi-docker
      homepage.name: Dockhand
    ports:
      - 3333:3000
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./docker/dockhand:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
  golink:
    cap_add:
      - NET_BIND_SERVICE
      - SETGID
      - SETUID
    cap_drop:
      - ALL
    container_name: golink
    depends_on:
      traefik:
        condition: service_started
    image: caddy:alpine
    labels:
      homepage.description: HTTP edge proxy with go link support
      homepage.group: Core
      homepage.icon: mdi-link-variant
      homepage.name: Caddy Edge
    ports:
      - 80:80
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /config:rw,noexec,nosuid,size=16m
      - /data:rw,noexec,nosuid,size=16m
    volumes:
      - ./docker/golink/Caddyfile:/etc/caddy/Caddyfile:ro
  newt:
    container_name: newt
    environment:
      - PANGOLIN_ENDPOINT=https://pangolin.${DOMAIN}
      - NEWT_ID=${NEWT_ID:?no newt id provided}
      - NEWT_SECRET=${NEWT_SECRET:?no newt secret provided}
    image: fosrl/newt
    restart: unless-stopped
  node-exporter:
    command:
      - --path.rootfs=/host
      - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
    container_name: node-exporter
    image: quay.io/prometheus/node-exporter
    network_mode: host
    pid: host
    restart: unless-stopped
    volumes:
      - /:/host:ro,rslave
  ntfy:
    cap_drop:
      - ALL
    command:
      - serve
    container_name: ntfy
    environment:
      TZ: UTC
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 40s
      test:
        - CMD-SHELL
        - wget -q --tries=1 http://localhost:80/v1/health -O - | grep -q '"healthy":true' || exit 1
      timeout: 10s
    hostname: ntfy
    image: binwiederhier/ntfy
    labels:
      homepage.description: Push notifications to phone or desktop
      homepage.group: Core
      homepage.href: https://ntfy.${DOMAIN}
      homepage.icon: ntfy
      homepage.name: ntfy
      traefik.enable: true
      traefik.http.services.ntfy.loadbalancer.server.port: 80
    ports:
      - 8001:80
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"
    volumes:
      - ./docker/ntfy/cache:/var/cache/ntfy
      - ./docker/ntfy/config/server.yml:/etc/ntfy/server.yml:ro
      - ./docker/ntfy/data:/var/lib/ntfy
  orb:
    container_name: orb
    image: orbforge/orb
    labels:
      com.centurylinklabs.watchtower.enable: true
      com.centurylinklabs.watchtower.scope: orb
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./docker/orb:/root/.config/orb
  tailscale:
    cap_add:
      - NET_ADMIN
      - NET_RAW
    cap_drop:
      - ALL
    container_name: tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      TS_AUTH_KEY: ${TAILSCALE_AUTH_KEY:?no tailscale auth key provided}
      TS_EXTRA_ARGS: --accept-routes=false --advertise-exit-node=true
      TS_ROUTES: 192.168.1.0/24
      TS_SOCKET: /var/run/tailscale/tailscaled.sock
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: "false"
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 60s
      test: [ "CMD-SHELL", "tailscale status --json | grep -q 'BackendState.*Running' || exit 1" ]
      timeout: 10s
    hostname: stargate
    image: tailscale/tailscale
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./docker/tailscale/data:/var/lib/tailscale:rw
      - ./docker/tailscale:/var/run/tailscale
  traefik:
    command:
      - --accesslog=true
      - --accesslog.format=json
      - --api.dashboard=true
      - --api.insecure=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/letsencrypt/acme.json
      - --entrypoints.golinks.address=:8090
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.forwardedHeaders.trustedIPs=192.168.1.3/32,172.52.0.0/16,10.0.0.0/8,100.64.0.0/10
      - --entrypoints.websecure.http.tls.certResolver=letsencrypt
      - --entrypoints.websecure.http.tls.domains[0].main=${DOMAIN}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN},*.stargate.${DOMAIN}
      - --entrypoints.websecure.http.tls=true
      - --log.level=INFO
      - --ping=true
      - --ping.entrypoint=websecure
      - --providers.docker.defaultRule=Host(`{{ index .Labels "com.docker.compose.service" }}.${DOMAIN}`) || Host(`{{ index .Labels "com.docker.compose.service" }}.stargate.${DOMAIN}`)
      - --providers.docker.exposedbydefault=true
      - --providers.docker=true
      - --providers.file.filename=/etc/traefik/dynamic.yaml
      - --providers.file.watch=true
      - --serverstransport.insecureskipverify=true
    container_name: traefik
    environment:
      CLOUDFLARE_DNS_API_TOKEN: ${CLOUDFLARE_API_TOKEN:?no cloudflare api token provided}
      CLOUDFLARE_EMAIL: ${CLOUDFLARE_EMAIL:?no cloudflare email provided}
      DOMAIN: ${DOMAIN:?no domain provided}
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL: ${CLOUDFLARE_EMAIL:?no cloudflare email provided}
    extra_hosts:
      - host.docker.internal:host-gateway
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: [ "CMD", "traefik", "version" ]
      timeout: 10s
    hostname: traefik
    image: traefik
    labels:
      homepage.description: Reverse proxy for exposing apps via HTTPS
      homepage.group: Core
      homepage.href: https://traefik.${DOMAIN}
      homepage.icon: traefik
      homepage.name: Traefik (stargate)
      homepage.widget.type: traefik
      homepage.widget.url: http://traefik:8080
      traefik.enable: true
      traefik.http.routers.traefik-main.rule: Host(`traefik.${DOMAIN}`)
      traefik.http.routers.traefik-main.service: traefik
      traefik.http.routers.traefik.rule: Host(`traefik.stargate.${DOMAIN}`)
      traefik.http.routers.traefik.service: api@internal
      traefik.http.services.traefik.loadbalancer.server.port: 8080
    ports:
      - 443:443
      - 8080:8080
      - 9080:80
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    volumes:
      - ./docker/letsencrypt:/etc/letsencrypt
      - ./docker/traefik:/etc/traefik:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
  uptime-kuma:
    cap_add:
      - SETGID
      - SETUID
    cap_drop:
      - ALL
    container_name: uptime-kuma
    hostname: uptime-kuma
    image: louislam/uptime-kuma:1
    labels:
      homepage.description: Component Health Tracking and Alerting
      homepage.group: Core
      homepage.href: https://uptime-kuma.${DOMAIN}
      homepage.icon: uptime-kuma
      homepage.name: Uptime Kuma
      homepage.widget.slug: technis
      homepage.widget.type: uptimekuma
      homepage.widget.url: http://stargate:3001
      traefik.enable: true
      traefik.http.services.uptime-kuma.loadbalancer.server.port: 3001
    ports:
      - 3001:3001
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./docker/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
  whoami:
    cap_drop:
      - ALL
    container_name: whoami
    image: traefik/whoami
    labels:
      homepage.description: HTTP request/response debugging
      homepage.group: Tools
      homepage.href: https://whoami.stargate.${DOMAIN}
      homepage.icon: mdi-web
      homepage.name: whoami
      traefik.enable: true
      traefik.http.routers.whoami.middlewares: basic-auth@file
      traefik.http.routers.whoami.rule: Host(`whoami.stargate.${DOMAIN}`)
      traefik.http.routers.whoami.service: whoami
      traefik.http.services.whoami.loadbalancer.server.port: 80
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
